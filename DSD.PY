# íŒŒì¼ëª…: streamlit_app.py

import streamlit as st
import requests
import pandas as pd
# import json (ì´ ì½”ë“œëŠ” pandasê°€ ë°ì´í„°ë¥¼ ì˜ ì²˜ë¦¬í•˜ë¯€ë¡œ í•„ìˆ˜ëŠ” ì•„ë‹™ë‹ˆë‹¤)

# -----------------------------------------------------
# ğŸ’¡ 2ë‹¨ê³„ì—ì„œ ê²€ì¦ëœ í•µì‹¬ API í•¨ìˆ˜ (ê·¸ëŒ€ë¡œ ë³µì‚¬)
# -----------------------------------------------------

SEARCH_URL = "https://collectionapi.metmuseum.org/public/collection/v1/search"
OBJECT_URL = "https://collectionapi.metmuseum.org/public/collection/v1/objects/"

def get_met_artworks(search_term, max_results=3):
    """
    MET APIì—ì„œ ì‘í’ˆì„ ê²€ìƒ‰í•˜ê³ , ì²« Nê°œì˜ ì‘í’ˆ ìƒì„¸ ì •ë³´ë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜.
    """
    
    search_params = {"q": search_term} 
    search_response = requests.get(SEARCH_URL, params=search_params)

    if search_response.status_code != 200:
        return pd.DataFrame(), f"ê²€ìƒ‰ ID ë¡œë”© ì‹¤íŒ¨. ìƒíƒœ ì½”ë“œ: {search_response.status_code}"

    search_data = search_response.json()
    object_ids = search_data.get('objectIDs', [])
    total_count = search_data.get('total', 0)
    
    if not object_ids:
        return pd.DataFrame(), f"'{search_term}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. (ì´ 0ê±´)"

    ids_to_fetch = object_ids[:max_results]
    
    results_list = []
    
    for object_id in ids_to_fetch:
        try:
            object_response = requests.get(OBJECT_URL + str(object_id), timeout=5)
            
            if object_response.status_code == 200:
                object_data = object_response.json()
                
                results_list.append({
                    "ì œëª©": object_data.get('title', 'N/A'),
                    "ì‘ê°€": object_data.get('artistDisplayName', 'N/A'),
                    "ì œì‘ ì—°ë„": object_data.get('objectDate', 'N/A'),
                    "ì´ë¯¸ì§€ URL": object_data.get('primaryImageSmall', 'N/A')
                })
        except requests.exceptions.RequestException:
            # ê°œë³„ ì‘í’ˆ ì˜¤ë¥˜ëŠ” ë¬´ì‹œí•˜ê³  ë‹¤ìŒ IDë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
            pass
            
    return pd.DataFrame(results_list), f"ì´ {total_count}ê±´ ì¤‘ {len(results_list)}ê±´ í‘œì‹œ"

# -----------------------------------------------------
# ğŸ’¡ Streamlit UI (ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤) ì‹œì‘
# -----------------------------------------------------

st.set_page_config(layout="wide")
st.title("ğŸ›ï¸ MET Museum ì‘í’ˆ íƒìƒ‰ê¸°")
st.markdown("---")

# 1. ì‚¬ìš©ìì—ê²Œ ê²€ìƒ‰ì–´ ì…ë ¥ë°›ê¸°
search_query = st.text_input("ê²€ìƒ‰í•  í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: flower, lion):", "flower")

# 2. ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œì§ ì‹¤í–‰ (2ë‹¨ê³„ ë¡œì§ì„ ì´ ì¡°ê±´ ì•ˆì— ë„£ìŠµë‹ˆë‹¤)
if st.button("ì‘í’ˆ ê²€ìƒ‰ ì‹œì‘"):
    
    # 3. ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
    with st.spinner(f"'{search_query}' í‚¤ì›Œë“œë¡œ ë°ì´í„°ë¥¼ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤..."):
        
        # 4. 2ë‹¨ê³„ì—ì„œ ë§Œë“  í•¨ìˆ˜ í˜¸ì¶œ
        df_result, status_message = get_met_artworks(search_query, max_results=5)
    
    # 5. ê²°ê³¼ì— ë”°ë¥¸ UI í‘œì‹œ
    if not df_result.empty:
        st.success(status_message)
        
        # ì‘í’ˆ ëª©ë¡ (DataFrame) í‘œì‹œ
        st.subheader("ê²€ìƒ‰ ê²°ê³¼ ëª©ë¡")
        st.dataframe(df_result[['ì œëª©', 'ì‘ê°€', 'ì œì‘ ì—°ë„']], use_container_width=True)
        
        # ì²« ë²ˆì§¸ ì‘í’ˆ ì´ë¯¸ì§€ í‘œì‹œ
        st.subheader("ì²« ë²ˆì§¸ ì‘í’ˆ ë¯¸ë¦¬ë³´ê¸°")
        first_image_url = df_result.iloc[0]['ì´ë¯¸ì§€ URL']
        if first_image_url != 'N/A':
            st.image(first_image_url, caption=df_result.iloc[0]['ì œëª©'], width=400)
        else:
            st.info("ì´ë¯¸ì§€ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
            
    else:
        st.warning(status_message)